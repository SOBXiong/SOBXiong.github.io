<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2.6.6'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>HBase - SOBXiong的博客</title>
  
    <meta name="keywords" content="BigData">
  
  
    <meta name="description" content="内容
HBase简介
HBase快速入门
HBase进阶
HBase-API
HBase优化
">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/SOBXiong/imageBed/favicon.png">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h'>
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
            <i class='https://cdn.jsdelivr.net/gh/SOBXiong/imageBed/favicon.png'></i>
          
          
            SOBXiong
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box reveal shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h1 class="title">
    <a href="/2020/07/17/BigData/HBase/">
      HBase
    </a>
  </h1>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="http://xiongjc.top" target="_blank" rel="nofollow noopener">
    <img src="https://cdn.jsdelivr.net/gh/SOBXiong/imageBed/hdImg_f757fa7e0fd65077ce52d251fc7a01d815860762755.jpg">
    <p>SOBXiong</p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/%E7%BC%96%E7%A8%8B/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>编程</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2020年7月17日</p>
  </a>
</div>

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><ul>
<li><a href="#HBase简介">HBase简介</a></li>
<li><a href="#HBase快速入门">HBase快速入门</a></li>
<li><a href="#HBase进阶">HBase进阶</a></li>
<li><a href="#HBase-API">HBase-API</a></li>
<li><a href="#HBase优化">HBase优化</a></li>
</ul>
<a id="more"></a>

<h2 id="HBase简介"><a href="#HBase简介" class="headerlink" title="HBase简介"></a>HBase简介</h2><ul>
<li>HBase定义：HBase是一种分布式、可扩展、支持海量数据存储的NoSQL数据库</li>
<li>HBase数据模型：逻辑上，HBase的数据模型同关系型数据库很类似，数据存储在一张表中，有行有列。但从HBase的底层物理存储结构(K-V)来看，HBase更像是一个<strong>multi-dimensional map(多维度Map)</strong><ul>
<li>逻辑结构<br><img src="HBase%E9%80%BB%E8%BE%91%E7%BB%93%E6%9E%84.png" alt="HBase逻辑结构"></li>
<li>物理存储结构<br><img src="HBase%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png" alt="HBase物理存储结构"></li>
<li>数据模型<ul>
<li>Name Space<br>命名空间，类似于关系型数据库的DatabBase概念，每个命名空间下有多个表。<strong>HBase有两个自带的命名空间，分别是hbase和default，hbase中存放的是HBase内置的表，default表是用户默认使用的命名空间</strong></li>
<li>Region<br>类似于关系型数据库的表概念。不同的是，<strong>HBase定义表时只需要声明列簇即可，不需要声明具体的列</strong>。这意味着，<strong>往HBase写入数据时，字段可以动态、按需指定</strong>。因此，和关系型数据库相比，HBase能够轻松应对字段变更的场景</li>
<li>Row<br>HBase表中的<strong>每行数据都由一个RowKey和多个Column(列)组成，数据是按照RowKey的字典顺序存储的，并且查询数据时只能根据RowKey进行检索</strong>，所以RowKey的设计十分重要</li>
<li>Column<br>HBase中的<strong>每个列都由Column Family(列簇)和Column Qualifier(列限定符)进行限定</strong>，例如info：name，info：age。建表时，只需指明列簇，而列限定符无需预先定义</li>
<li>Time Stamp<br>用于标识数据的不同版本(version)，每条数据写入时，如果不指定时间戳，系统会自动为其加上该字段，其值为写入HBase的时间</li>
<li>Cell<br>由{rowkey,column Family:column Qualifier,time Stamp}唯一确定的单元。cell中的数据是没有类型的，全部是字节码形式存贮</li>
</ul>
</li>
</ul>
</li>
<li>HBase基本架构<br><img src="HBase%E6%9E%B6%E6%9E%84(%E4%B8%8D%E5%AE%8C%E6%95%B4%E7%89%88).png" alt="HBase架构(不完整版)"><br>架构角色：<ul>
<li>Region Server<br>Region Server为Region的管理者，其实现类为<strong>HRegionServer</strong>，主要作用如下:<br>对于数据的操作：get,put,delete<br>对于Region的操作：splitRegion、compactRegion</li>
<li>Master<br>Master是所有Region Server的管理者，其实现类为HMaster，主要作用如下：<br>对于表的操作：create,delete,alter<br>对于RegionServer的操作：分配regions到每个RegionServer，监控每个RegionServer的状态，负载均衡和故障转移</li>
<li>Zookeeper<br>HBase通过Zookeeper来做Master的高可用、RegionServer的监控、元数据的入口以及集群配置的维护等工作</li>
<li>HDFS<br>HDFS为HBase提供最终的底层数据存储服务，同时为HBase提供高可用的支持</li>
</ul>
</li>
</ul>
<h2 id="HBase快速入门"><a href="#HBase快速入门" class="headerlink" title="HBase快速入门"></a>HBase快速入门</h2><ul>
<li><p>HBase安装部署</p>
<ul>
<li><p>Zookeeper正常部署</p>
</li>
<li><p>Hadoop(主要是HDFS)正常部署</p>
</li>
<li><p>HBase正常部署</p>
<ul>
<li><p>解压HBase：tar -zxvf hbase-2.2.5-bin.tar.gz -C /opt/module</p>
</li>
<li><p>修改HBase的配置文件</p>
<ul>
<li><p>修改hbase-env.sh的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/opt/module/jdk1.8.0_251</span><br><span class="line"><span class="meta">#</span><span class="bash"> 自行管理zookeeper</span></span><br><span class="line">export HBASE_MANAGES_ZK=false</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改hbase-site.xml的内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 设置为分布式部署 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 设置HBase的默认存储文件的路径 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop1:9000/HBase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 设置zookeeper的集群地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop1,hadoop2,hadoop3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 设置zookeeper的data目录 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/zookeeper-3.6.1/zkData<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改regionservers文件(配置集群节点)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop1</span><br><span class="line">hadoop2</span><br><span class="line">hadoop3</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>软链接hadoop配置文件到HBase</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /opt/module/hadoop-3.1.3/etc/hadoop/core-site.xml /opt/module/hbase-2.2.5/conf/core-site.xml</span><br><span class="line">ln -s /opt/module/hadoop-3.1.3/etc/hadoop/hdfs-site.xml /opt/module/hbase-2.2.5/conf/hdfs-site.xml</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>将HBase远程发送到集群其他节点：xsync hbase-2.2.5/</p>
</li>
<li><p>启动HBase服务</p>
<ul>
<li>单独启动方式(提示:如果集群之间的节点时间不同步，会导致 regionserver 无法启动，抛出ClockOutOfSyncException 异常)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin/hbase-daemon.sh start master</span><br><span class="line">bin/hbase-daemon.sh start regionserver</span><br></pre></td></tr></table></figure>

<ul>
<li>群起集群启动方式：bin/start-hbase.sh(停止:bin/stop-hbase.sh)</li>
</ul>
</li>
<li><p>查看HBase页面：<a href="http://hadoop1:16010" target="_blank" rel="noopener">http://hadoop1:16010</a></p>
</li>
</ul>
</li>
<li><p>HBase Shell操作</p>
<ul>
<li><p>基本操作</p>
<ul>
<li>进入HBase客户端命令行：bin/hbase shell</li>
<li>查看帮助命令：help</li>
<li>查看当前数据库的所有表：list</li>
</ul>
</li>
<li><p>表的操作</p>
<ul>
<li><p>创建表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create 'student','info'</span><br></pre></td></tr></table></figure>
</li>
<li><p>插入(更新)数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">put 'student','1001','info:sex','male'</span><br></pre></td></tr></table></figure>
</li>
<li><p>扫描查看表数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scan 'student'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 左闭右开</span></span><br><span class="line">scan 'student',&#123;STARTROW =&gt; '1001', STOPROW =&gt; '1003'&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看多版本的表数(无需在表上设置存放版本)</span></span><br><span class="line">scan 'student',&#123;RAW =&gt; true, VERSIONS =&gt; 10&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看表结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">describe 'student'</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看指定行或指定行的指定列的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">get 'student','1001'</span><br><span class="line">get 'student','1001','info:name'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看name列的三个版本的数据(需要在表上设置存放版本)</span></span><br><span class="line">get 'student','1001',&#123;COLUMN =&gt; 'info:name',VERSIONS =&gt; 3&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>统计表数据行数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count 'student'</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除某rowkey的全部数据</span></span><br><span class="line">deleteall 'student','1001'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除某rowkey的某一列数据</span></span><br><span class="line">delete 'student','1002','info:sex'</span><br></pre></td></tr></table></figure>
</li>
<li><p>清空表数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 提示: 清空表的操作顺序为先<span class="built_in">disable</span>,然后再truncate</span></span><br><span class="line">truncate 'student'</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 首先要将表设置为<span class="built_in">disable</span>状态</span></span><br><span class="line">disable 'student'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除表</span></span><br><span class="line">drop 'student'</span><br></pre></td></tr></table></figure>
</li>
<li><p>变更表信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置info列簇的数据存放3个版本</span></span><br><span class="line">alter 'student',&#123;NAME =&gt; 'info',VERSIONS =&gt; 3&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="HBase进阶"><a href="#HBase进阶" class="headerlink" title="HBase进阶"></a>HBase进阶</h2><ul>
<li><p>架构原理<br><img src="HBase%E8%AF%A6%E7%BB%86%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="HBase详细架构图"></p>
<ul>
<li>StoreFile<br>保存实际数据的物理文件，StoreFile以HFile的形式存储在HDFS上。每个Store会有一个或多个StoreFile(HFile)，数据在每个StoreFile中都是有序的</li>
<li>MemStore<br>写缓存，由于HFile中的数据要求是有序的，所以数据是先存储在MemStore中，排好序后，等到达刷写时机才会刷写到 HFile，每次刷写都会形成一个新的HFile</li>
<li>WAL<br>由于数据要经MemStore排序后才能刷写到HFile，但把数据保存在内存中会有很高的概率导致数据丢失，为了解决这个问题，数据会先写在一个叫做Write-Ahead logfile的文件(简称WAL)中，然后再写入MemStore中。所以在系统出现故障的时候，数据可以通过这个日志文件重建</li>
</ul>
</li>
<li><p>写流程<br><img src="HBase%E5%86%99%E6%B5%81%E7%A8%8B.png" alt="HBase写流程"></p>
<ul>
<li>Client先访问zookeeper，获取hbase:meta表位于哪个Region Server</li>
<li>访问对应的Region Server，获取hbase:meta表，根据读请求的namespace:table/rowkey，查询出目标数据位于哪个Region Server中的哪个Region中。并将该table的region信息以及meta表的位置信息缓存在客户端的meta cache，方便下次访问</li>
<li>与目标Region Server进行通讯</li>
<li>将数据顺序写入(追加)到WAL</li>
<li>将数据写入对应的MemStore，数据会在MemStore进行排序</li>
<li>向客户端发送ack</li>
<li>等达到MemStore的刷写时机后，将数据刷写到HFile</li>
</ul>
</li>
<li><p>MemStore Flush<br><img src="MemStore-Flush%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="MemStore-Flush示意图"><br>MemStore刷写时机：</p>
<ul>
<li>当某个memstore的大小达到了hbase.hregion.memstore.flush.size(默认值128M)，其所在 region的所有memstore都会刷写。当memstore的大小达到了hbase.hregion.memstore.flush.size * hbase.hregion.memstore.block.multiplier(默认值4)时，会阻止继续往该memstore写数据</li>
<li>当region server中memstore的总大小达到java_heapsize * hbase.regionserver.global.memstore.size * hbase.regionserver.global.memstore.size.lower.limit(默认值0.95)，region会按照其所有memstore的大小顺序(由大到小)依次进行刷写。直到region server中所有memstore的总大小减小到上述值以下(当前还可以写数据)。当region server中memstore的总大小达到java_heapsize * hbase.regionserver.global.memstore.size时，会阻止继续往所有的memstore写数据</li>
<li>到达自动刷写的时间，也会触发memstore flush。自动刷新的时间间隔由该属性进行配置：hbase.regionserver.optionalcacheflushinterval(默认1小时)</li>
<li>当WAL文件的数量超过hbase.regionserver.max.logs，region会按照时间顺序依次进行刷写，直到WAL文件数量减小到hbase.regionserver.max.log 以下(该属性名已经废弃——无法手动设置，默认值为32;但是可以设置每个log文件的blockSize,相当于增加单个log文件的存储量,默认为hdfs的块大小128M)</li>
</ul>
</li>
<li><p>读流程<br><img src="HBase%E8%AF%BB%E6%B5%81%E7%A8%8B.png" alt="HBase读流程"></p>
<ul>
<li>Client先访问zookeeper，获取hbase:meta表位于哪个Region Server</li>
<li>访问对应的Region Server，获取hbase:meta表，根据读请求的namespace:table/rowkey，查询出目标数据位于哪个Region Server中的哪个Region中。并将该table的region信息以及meta表的位置信息缓存在客户端的meta cache，方便下次访问</li>
<li>与目标Region Server进行通讯</li>
<li>分别在Block Cache(读缓存——内存)，MemStore(内存)和Store File(HFile磁盘文件)中查询目标数据(同时查内存和磁盘,因为不知道哪个timestamp先)，并将查到的所有数据进行合并(Merge)。此处所有数据是指同一条数据的不同版本(timestamp)或者不同的类型(Put/Delete)</li>
<li>将从文件中查询到的数据块(Block,HFile数据存储单元,默认大小为64KB)缓存到Block Cache</li>
<li>将合并后的最终结果返回给客户端</li>
</ul>
</li>
<li><p>StoreFile Compaction<br>由于memstore每次刷写都会生成一个新的HFile，且同一个字段的不同版本(timestamp)和不同类型(Put/Delete)有可能会分布在不同的HFile中，因此查询时需要遍历所有的HFile。为了减少HFile的个数，以及清理掉过期和删除的数据，会进行StoreFile Compaction<br>Compaction分为两种，分别是Minor Compaction和Major Compaction。Minor Compaction会将临近的若干个较小的HFile合并成一个较大的HFile，但不会清理过期和删除的数据。Major Compaction会将一个Store下的所有的HFile合并成一个大HFile，并且会清理掉过期和删除的数据<br><img src="StoreFile-Compaction%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="StoreFile-Compaction示意图"></p>
</li>
<li><p>Region Split<br>默认情况下，每个Table起初只有一个Region，随着数据的不断写入，Region会自动进行拆分。刚拆分时，两个子Region都位于当前的Region Server，但处于负载均衡的考虑，HMaster有可能会将某个 Region转移给其他的Region Server。<br>Region Split时机：<br>  当1个region中的某个Store下所有StoreFile的总大小超过<strong>Min(R ^ 2 * hbase.hregion.memstore.flush.size , hbase.hregion.max.filesize)</strong>，该Region就会进行拆分，其中 R为当前Region Server中属于该Table的个数</p>
</li>
</ul>
<h2 id="HBase-API"><a href="#HBase-API" class="headerlink" title="HBase-API"></a>HBase-API</h2><ul>
<li><p>环境准备<br>新建maven项目后在pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>HBaseAPI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApi</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Connection connection;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Admin admin;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 1、获取配置文件信息</span></span><br><span class="line">      Configuration configuration = HBaseConfiguration.create();</span><br><span class="line">      configuration.set(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"hadoop1,hadoop2,hadoop3"</span>);</span><br><span class="line">      <span class="comment">// 2、创建连接对象</span></span><br><span class="line">      connection = ConnectionFactory.createConnection(configuration);</span><br><span class="line">      <span class="comment">// 3、创建admin对象</span></span><br><span class="line">      admin = connection.getAdmin();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关闭资源</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (admin != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        admin.close();</span><br><span class="line">        admin = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        connection.close();</span><br><span class="line">        connection = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1、测试表是否存在</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isTableExist</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> admin.tableExists(TableName.valueOf(tableName));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2、创建表</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTable</span><span class="params">(String tableName, String... columnFamilies)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1、判断是否存在列簇信息</span></span><br><span class="line">    <span class="keyword">if</span> (columnFamilies.length == <span class="number">0</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">"请设置列簇信息!"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2、判断表是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (isTableExist(tableName)) &#123;</span><br><span class="line">      System.out.println(tableName + <span class="string">"表已存在!"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;ColumnFamilyDescriptor&gt; columnFamilyList = <span class="keyword">new</span> ArrayList&lt;ColumnFamilyDescriptor&gt;();</span><br><span class="line">    <span class="comment">// 3、循环添加列簇信息</span></span><br><span class="line">    <span class="keyword">for</span> (String columnFamily : columnFamilies) &#123;</span><br><span class="line">      <span class="comment">// 添加列簇信息</span></span><br><span class="line">      columnFamilyList.add(ColumnFamilyDescriptorBuilder.newBuilder(columnFamily.getBytes()).build());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4、创建表描述器</span></span><br><span class="line">    TableDescriptor tableDescriptor = TableDescriptorBuilder</span><br><span class="line">            .newBuilder(TableName.valueOf(tableName))</span><br><span class="line">            .setColumnFamilies(columnFamilyList)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">// 5、创建表</span></span><br><span class="line">    admin.createTable(tableDescriptor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3、删除表</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dropTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1、判断表是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (!isTableExist(tableName)) &#123;</span><br><span class="line">      System.out.println(tableName + <span class="string">"表不存在!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2、下线表</span></span><br><span class="line">    admin.disableTable(TableName.valueOf(tableName));</span><br><span class="line">    <span class="comment">// 3、删除表</span></span><br><span class="line">    admin.deleteTable(TableName.valueOf(tableName));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4、创建命名空间</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createNameSpace</span><span class="params">(String nameSpaceName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、创建命名空间描述器</span></span><br><span class="line">    NamespaceDescriptor namespaceDescriptor = NamespaceDescriptor.create(nameSpaceName)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">// 2、创建命名空间</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      admin.createNamespace(namespaceDescriptor);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamespaceExistException e) &#123;</span><br><span class="line">      System.out.println(nameSpaceName + <span class="string">"命名空间已存在!"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 5、向表中插入数据</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putData</span><span class="params">(String tableName, String rowKey, String columnFamily, String column, String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1、获取表对象</span></span><br><span class="line">    Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">    <span class="comment">// 2、创建put对象</span></span><br><span class="line">    Put put = <span class="keyword">new</span> Put(Bytes.toBytes(rowKey));</span><br><span class="line">    <span class="comment">// 3、给put对象赋值</span></span><br><span class="line">    put.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(column), Bytes.toBytes(value));</span><br><span class="line">    <span class="comment">// 4、插入数据</span></span><br><span class="line">    table.put(put);</span><br><span class="line">    <span class="comment">// 5、关闭表</span></span><br><span class="line">    table.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6、获取数据(get)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getData</span><span class="params">(String tableName, String rowKey, String columnFamily, String column)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1、获取表对象</span></span><br><span class="line">    Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">    <span class="comment">// 2、创建get对象</span></span><br><span class="line">    Get get = <span class="keyword">new</span> Get(Bytes.toBytes(rowKey));</span><br><span class="line">    <span class="comment">// 指定获取的列簇和列</span></span><br><span class="line">    <span class="keyword">if</span> (column != <span class="keyword">null</span> &amp;&amp; !column.isEmpty() &amp;&amp; columnFamily != <span class="keyword">null</span> &amp;&amp; !columnFamily.isEmpty()) &#123;</span><br><span class="line">      get.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(column));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (columnFamily != <span class="keyword">null</span> &amp;&amp; !columnFamily.isEmpty()) &#123;</span><br><span class="line">      get.addFamily(Bytes.toBytes(columnFamily));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置获取数据的版本数</span></span><br><span class="line">    get.readVersions(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 3、获取数据</span></span><br><span class="line">    Result result = table.get(get);</span><br><span class="line">    <span class="comment">// 4、解析result</span></span><br><span class="line">    <span class="keyword">for</span> (Cell cell : result.rawCells()) &#123;</span><br><span class="line">      <span class="comment">// 5、打印数据</span></span><br><span class="line">      System.out.println(<span class="string">"columnFamily = "</span> + Bytes.toString(CellUtil.cloneFamily(cell)));</span><br><span class="line">      System.out.println(<span class="string">"column = "</span> + Bytes.toString(CellUtil.cloneQualifier(cell)));</span><br><span class="line">      System.out.println(<span class="string">"value = "</span> + Bytes.toString(CellUtil.cloneValue(cell)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6、关闭表连接</span></span><br><span class="line">    table.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 7、获取数据(scan)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1、获取表对象</span></span><br><span class="line">    Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">    <span class="comment">// 2、构建scan对象</span></span><br><span class="line">    Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">    <span class="comment">// 构建过滤器</span></span><br><span class="line">    <span class="comment">// RowFilter rowFilter = new RowFilter(CompareOperator.EQUAL, new SubstringComparator(uid + '_'));</span></span><br><span class="line">    <span class="comment">// scan.setFilter(rowFilter);</span></span><br><span class="line">    <span class="comment">// 3、扫描表</span></span><br><span class="line">    ResultScanner resultScanner = table.getScanner(scan);</span><br><span class="line">    <span class="comment">// 4、解析resultScanner</span></span><br><span class="line">    <span class="keyword">for</span> (Result result : resultScanner) &#123;</span><br><span class="line">      <span class="comment">// 5、解析result</span></span><br><span class="line">      <span class="keyword">for</span> (Cell cell : result.rawCells()) &#123;</span><br><span class="line">        <span class="comment">// 6、打印数据</span></span><br><span class="line">        System.out.println(<span class="string">"rowKey = "</span> + Bytes.toString(CellUtil.cloneRow(cell)));</span><br><span class="line">        System.out.println(<span class="string">"columnFamily = "</span> + Bytes.toString(CellUtil.cloneFamily(cell)));</span><br><span class="line">        System.out.println(<span class="string">"column = "</span> + Bytes.toString(CellUtil.cloneQualifier(cell)));</span><br><span class="line">        System.out.println(<span class="string">"value = "</span> + Bytes.toString(CellUtil.cloneValue(cell)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5、关闭table对象</span></span><br><span class="line">    table.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 8、删除数据,delete是一种特殊的put操作,打标记</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteData</span><span class="params">(String tableName, String rowKey, String columnFamily, String column)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1、获取表对象</span></span><br><span class="line">    Table table = connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">    <span class="comment">// 2、构建删除对象,deleteFamily标记,rowKey下所有columnFamily的所有version</span></span><br><span class="line">    Delete delete = <span class="keyword">new</span> Delete(Bytes.toBytes(rowKey));</span><br><span class="line">    <span class="comment">// 设置删除的列簇 deleteFamily标记对应HBase Cli的deleteall命令</span></span><br><span class="line">    <span class="comment">// 删除列对应部分delete命令,删除指定columnFamily的所有version</span></span><br><span class="line">    <span class="comment">// delete.addFamily(Bytes.toBytes(columnFamily));</span></span><br><span class="line">    <span class="comment">// 设置删除的列 deleteColumn标记</span></span><br><span class="line">    <span class="comment">// delete.addColumns(Bytes.toBytes(columnFamily), Bytes.toBytes(column));</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      设置删除的列 delete标记</span></span><br><span class="line"><span class="comment">      普通情况：上一个老值冒出来了,新值删去</span></span><br><span class="line"><span class="comment">      另一种情况：接连着push两条name,flush之后再使用该方式删除,没数据了</span></span><br><span class="line"><span class="comment">      无法确定flush时机,删除最好使用addColumns(防止出错)</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="comment">// delete.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(column));</span></span><br><span class="line">    <span class="comment">// 设置删除的列 deleteColumn标记,删除在小于等于timestamp的所有版本</span></span><br><span class="line">    <span class="comment">// delete.addColumns(Bytes.toBytes(columnFamily), Bytes.toBytes(column), 1595307747400L);</span></span><br><span class="line">    <span class="comment">// 设置删除的列 delete标记,删除等于timestamp的那一个版本</span></span><br><span class="line">    delete.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(column), <span class="number">1595307747419L</span>);</span><br><span class="line">    <span class="comment">// 3、执行删除操作</span></span><br><span class="line">    table.delete(delete);</span><br><span class="line">    <span class="comment">// 4、关闭连接</span></span><br><span class="line">    table.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// System.out.println("isTableExist = " + isTableExist("stu4"));</span></span><br><span class="line">    <span class="comment">// createTable("stu6", "info1", "info2");</span></span><br><span class="line">    <span class="comment">// System.out.println("isTableExist = " + isTableExist("stu5"));</span></span><br><span class="line">    <span class="comment">// dropTable("stu6");</span></span><br><span class="line">    <span class="comment">// createNameSpace("test");</span></span><br><span class="line">    <span class="comment">// createTable("test:xixi", "info");</span></span><br><span class="line">    <span class="comment">// putData("stu4", "1006", "info", "name", "haha");</span></span><br><span class="line">    <span class="comment">// scanTable("fruit");</span></span><br><span class="line">    deleteData(<span class="string">"stu"</span>, <span class="string">"1008"</span>, <span class="string">"info1"</span>, <span class="string">"name"</span>);</span><br><span class="line">    close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>MapReduce<br>通过HBase的相关Java API，我们可以实现伴随HBase操作的MapReduce过程，比如使用MapReduce将数据从本地文件系统导入到HBase的表中，比如我们从HBase中读取一些原始数据后使用MapReduce做数据分析</p>
<ul>
<li><p>官方HBase-MapReduce案例</p>
<ul>
<li><p>查看HBase的MapReduce任务的执行需要的依赖包：bin/hbase mapredcp以及bin/hbase classpath</p>
</li>
<li><p>环境变量的导入(/etc/profile中配置;在生产环境中最好使用临时操作,以下命令在命令行下输入,只在当前次登录生效)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> HBASE_HOME</span></span><br><span class="line">export HBASE_HOME=/opt/module/hbase-2.2.5</span><br><span class="line">export HADOOP_CLASSPATH=`$&#123;HBASE_HOME&#125;/bin/hbase classpath`</span><br><span class="line">export HADOOP_CLASSPATH=$HADOOP_CLASSPATH:`$&#123;HBASE_HOME&#125;/bin/hbase mapredcp`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存后执行<span class="built_in">source</span> /etc/profile</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>执行官方的MapReduce任务(输出都在控制台上)</p>
<ul>
<li><p>案例一：统计stu表中有多少行数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar lib/hbase-mapreduce-2.2.5.jar rowcounter stu</span><br></pre></td></tr></table></figure>
</li>
<li><p>案例二：使用MapReduce将本地数据导入到HBase</p>
<ul>
<li><p>在本地创建一个tsv格式的文件：fruit.tsv(csv格式以’,’隔开,而tsv格式以’\t’隔开)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1001  Apple Red</span><br><span class="line">1002  Pear  Yellow</span><br><span class="line">1003  Pineapple Yellow</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建HBase表(不存在会报错)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create 'fruit','info'</span><br></pre></td></tr></table></figure>
</li>
<li><p>将fruit.tsv文件上传到HDFS上(根目录上)：hdfs dfs -put fruit.tsv /</p>
</li>
<li><p>执行MapReduce任务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar lib/hbase-mapreduce-2.2.5.jar \</span><br><span class="line">importtsv -Dimporttsv.columns=HBASE_ROW_KEY,info:name,info:color fruit \</span><br><span class="line">hdfs://hadoop1:9000/fruit.tsv</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用scan命令查看导入后的结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scan 'fruit'</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>自定义HBase-MapReduce</p>
<ul>
<li><p>导入相应的依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-mapreduce<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-auth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-mapreduce-client-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-mapreduce-client-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-mapreduce-client-jobclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>示例一：将HDFS上数据表fruit.tsv导入到HBase的fruit1表中(打包扔到集群上运行)</p>
<ul>
<li><p>FruitMapper类，用于读取HDFS上数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    context.write(key, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>FruitReducer类，用于将数据写入到HBase中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitReducer</span> <span class="keyword">extends</span> <span class="title">TableReducer</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(LongWritable key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// 1、遍历values: 1001 Apple   red</span></span><br><span class="line">  <span class="keyword">for</span> (Text value : values) &#123;</span><br><span class="line">    <span class="comment">// 2、获取每一行数据</span></span><br><span class="line">    String[] fields = value.toString().split(<span class="string">"\t"</span>);</span><br><span class="line">    <span class="comment">// 3、构建Put对象</span></span><br><span class="line">    Put put = <span class="keyword">new</span> Put(Bytes.toBytes(fields[<span class="number">0</span>]));</span><br><span class="line">    <span class="comment">// 4、给Put对象复制</span></span><br><span class="line">    put.addColumn(Bytes.toBytes(<span class="string">"info"</span>), Bytes.toBytes(<span class="string">"name"</span>), Bytes.toBytes(fields[<span class="number">1</span>]));</span><br><span class="line">    put.addColumn(Bytes.toBytes(<span class="string">"info"</span>), Bytes.toBytes(<span class="string">"color"</span>), Bytes.toBytes(fields[<span class="number">2</span>]));</span><br><span class="line">    <span class="comment">// 5、写出</span></span><br><span class="line">    context.write(NullWritable.get(), put);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>FruitDriver类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitDriver</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 定义一个Configuration</span></span><br><span class="line">  <span class="keyword">private</span> Configuration configuration = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1、获取job对象</span></span><br><span class="line">    Job job = Job.getInstance(configuration);</span><br><span class="line">    <span class="comment">// 2、设置驱动类路径</span></span><br><span class="line">    job.setJarByClass(FruitDriver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 3、设置Mapper和Mapper输出的KV类型</span></span><br><span class="line">    job.setMapperClass(FruitMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    job.setMapOutputKeyClass(LongWritable<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    job.setMapOutputValueClass(Text<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 4、设置Reducer类</span></span><br><span class="line">    TableMapReduceUtil.initTableReducerJob(</span><br><span class="line">            args[<span class="number">1</span>],</span><br><span class="line">            FruitReducer<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">job</span></span></span><br><span class="line"><span class="class">    )</span>;</span><br><span class="line">    <span class="comment">// 5、设置输入参数</span></span><br><span class="line">    FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</span><br><span class="line">    <span class="comment">// 6、提交任务</span></span><br><span class="line">    <span class="keyword">boolean</span> result = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> result ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration configuration)</span> </span>&#123; <span class="keyword">this</span>.configuration = configuration; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> configuration; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">      <span class="keyword">int</span> run = ToolRunner.run(configuration, <span class="keyword">new</span> FruitDriver(), args);</span><br><span class="line">      System.exit(run);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用maven进行package打包操作，将jar包上传到集群上</p>
</li>
<li><p>在命令行中操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar HBaseTest-1.0-SNAPSHOT.jar com.xiong.mr.FruitDriver /fruit.tsv fruit1</span><br></pre></td></tr></table></figure>
</li>
<li><p>在HBase Cli上查看fruit1表的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scan 'fruit1'</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>示例二：读取fruit表并过滤数据，将结果输出到fruit2表(远端连接运行)</p>
<ul>
<li><p>Fruit2Mapper类，用于读取和过滤HBase fruit表中的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit2Mapper</span> <span class="keyword">extends</span> <span class="title">TableMapper</span>&lt;<span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(ImmutableBytesWritable key, Result value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 构建Put对象</span></span><br><span class="line">    Put put = <span class="keyword">new</span> Put(key.get());</span><br><span class="line">    <span class="comment">// 1、获取数据</span></span><br><span class="line">    <span class="keyword">for</span> (Cell cell : value.rawCells()) &#123;</span><br><span class="line">      <span class="comment">// 2、判断当前的cell是否为name列</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"name"</span>.equals(Bytes.toString(CellUtil.cloneQualifier(cell)))) &#123;</span><br><span class="line">        <span class="comment">// 3、给Put对象赋值</span></span><br><span class="line">        put.add(cell);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4、写出</span></span><br><span class="line">    context.write(key, put);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fruit2Reducer类，用于将处理后的数据输出到fruit2表中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit2Reducer</span> <span class="keyword">extends</span> <span class="title">TableReducer</span>&lt;<span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(ImmutableBytesWritable key, Iterable&lt;Put&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 遍历写出</span></span><br><span class="line">    <span class="keyword">for</span> (Put value : values) &#123;</span><br><span class="line">      context.write(NullWritable.get(), value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fruit2Driver类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit2Driver</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 定义配置信息</span></span><br><span class="line">  <span class="keyword">private</span> Configuration configuration = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1、获取Job对象</span></span><br><span class="line">    Job job = Job.getInstance(configuration);</span><br><span class="line">    <span class="comment">// 2、设置主类路径</span></span><br><span class="line">    job.setJarByClass(Fruit2Driver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 3、设置Mapper及输出KV类型</span></span><br><span class="line">    TableMapReduceUtil.initTableMapperJob(</span><br><span class="line">            <span class="string">"fruit"</span>,</span><br><span class="line">            <span class="keyword">new</span> Scan(),</span><br><span class="line">            Fruit2Mapper<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">ImmutableBytesWritable</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">Put</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">job</span></span></span><br><span class="line"><span class="class">    )</span>;</span><br><span class="line">    <span class="comment">// 4、设置Reducer及输出表</span></span><br><span class="line">    TableMapReduceUtil.initTableReducerJob(</span><br><span class="line">            <span class="string">"fruit2"</span>,</span><br><span class="line">            Fruit2Reducer<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">            <span class="title">job</span></span></span><br><span class="line"><span class="class">    )</span>;</span><br><span class="line">    <span class="comment">// 5、提交任务</span></span><br><span class="line">    <span class="keyword">boolean</span> result = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> result ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration configuration)</span> </span>&#123; <span class="keyword">this</span>.configuration = configuration; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> configuration; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Configuration configuration = HBaseConfiguration.create();</span><br><span class="line">      <span class="keyword">int</span> run = ToolRunner.run(configuration, <span class="keyword">new</span> Fruit2Driver(), args);</span><br><span class="line">      System.exit(run);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将集群上HBase的hbase-site.xml内容复制到当前工程下的resource/hbase-site.xml上，文件名不得修改</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- HBase默认存储文件的路径 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop1:9000/HBase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- zk的集群地址 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop1,hadoop2,hadoop3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- zk的data目录 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/zookeeper-3.6.1/zkData<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>./tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行查看结果(在HBase Cli中scan fruit2表)</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>与Hive的集成</p>
<ul>
<li><p>HBase和Hive的对比</p>
<ul>
<li>Hive<ul>
<li>数据仓库：Hive的本质其实就相当于将HDFS中已经存储的文件在Mysql中做了一个双射关系，以方便使用HQL去管理查询</li>
<li>用于数据分析、清洗：Hive适用于离线的数据分析和清洗，延迟较高</li>
<li>基于HDFS、MapReduce：Hive存储的数据依旧在DataNode上，编写的HQL语句终将是转换为MapReduce代码执行</li>
</ul>
</li>
<li>HBase<ul>
<li>数据库：是一种<strong>面向列簇存储</strong>的<strong>非关系型数据库</strong></li>
<li>用于存储结构化和非结构化的数据：适用于单表非关系型数据的存储，不适合做关联查询，类似JOIN等操作</li>
<li>基于HDFS：数据持久化存储的体现形式是HFile，存放于DataNode中，被ResionServer以region的形式进行管理</li>
<li>延迟较低，接入在线业务使用：面对大量的企业数据，HBase可以直线单表大量数据的存储，同时提供了高效的数据访问速度</li>
</ul>
</li>
</ul>
</li>
<li><p>HBase和Hive集成使用(可能会有版本兼容问题,生产环境会采用CDH方式或者运维人员帮忙处理)</p>
<ul>
<li><p>环境准备<br>后续可能会在操作Hive的同时会对HBase产生影响，所以Hive需要持有操作HBase的Jar，那么需要拷贝Hive所依赖的Jar(或者使用软连接的形式)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可以临时设置,也可在/etc/profile中永久设置</span></span><br><span class="line">export HBASE_HOME=/opt/module/hbase-2.2.5</span><br><span class="line">export HIVE_HOME=/opt/module/hive-3.1.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置软链接,<span class="string">'\'</span>为shell命令的分隔符,多行时最好采用</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-common-2.2.5.jar \</span><br><span class="line"><span class="meta">$</span><span class="bash">HIVE_HOME/lib/hbase-common-2.2.5.jar</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-server-2.2.5.jar \</span><br><span class="line"><span class="meta">$</span><span class="bash">HIVE_HOME/lib/hbase-server-2.2.5.jar</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-client-2.2.5.jar \</span><br><span class="line"><span class="meta">$</span><span class="bash">HIVE_HOME/lib/hbase-client-2.2.5.jar</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-protocol-2.2.5.jar \</span><br><span class="line"><span class="meta">$</span><span class="bash">HIVE_HOME/lib/hbase-protocol-2.2.5.jar</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-it-2.2.5.jar \</span><br><span class="line"><span class="meta">$</span><span class="bash">HIVE_HOME/lib/hbase-it-2.2.5.jar</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-hadoop2-compat-2.2.5.jar \</span><br><span class="line"><span class="meta">$</span><span class="bash">HIVE_HOME/lib/hbase-hadoop2-compat-2.2.5.jar</span></span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-hadoop-compat-2.2.5.jar \</span><br><span class="line"><span class="meta">$</span><span class="bash">HIVE_HOME/lib/hbase-hadoop-compat-2.2.5.jar</span></span><br></pre></td></tr></table></figure>

<p>同时需要在hive-site.xml中修改zookeeper的属性(连接hbase需要与zk交互)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 设置zk节点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop1,hadoop2,hadoop3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The list of ZooKeeper servers to talk to. This is only needed for read/write locks.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 设置zk client通信端口 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.zookeeper.client.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The port of ZooKeeper servers to talk to. This is only needed for read/write locks.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>实操</p>
<ul>
<li><p>案例一：建立Hive表，关联HBase表，插入数据到Hive表的同时能够影响HBase表</p>
<ul>
<li><p>在Hive中创建表同时关联HBase(完成后可在Hive和HBase的Cli中查看)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE hive_hbase_emp_table(</span><br><span class="line">empno int,</span><br><span class="line">ename string,</span><br><span class="line">job string,</span><br><span class="line">mgr int,</span><br><span class="line">hiredate string,</span><br><span class="line">sal double,</span><br><span class="line">comm double,</span><br><span class="line">deptno int)</span><br><span class="line">STORED BY 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span><br><span class="line">WITH SERDEPROPERTIES ("hbase.columns.mapping" = ":key,info:ename,info:job,info:mgr,info:hiredate,info:sal,info:comm,info:deptno")</span><br><span class="line">TBLPROPERTIES ("hbase.table.name" = "hbase_emp_table");</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Hive中创建中间临时表，用于装载文件中的数据(因为hbase的文件格式不是txt,所有不能直接由txt导入,需要中间表)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE emp(</span><br><span class="line">empno int,</span><br><span class="line">ename string,</span><br><span class="line">job string,</span><br><span class="line">mgr int,</span><br><span class="line">hiredate string,</span><br><span class="line">sal double,</span><br><span class="line">comm double,</span><br><span class="line">deptno int)</span><br><span class="line">row format delimited fields terminated by '\t';</span><br></pre></td></tr></table></figure>
</li>
<li><p>向Hive中间表中装载数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data local inpath '/opt/module/data/hive/emp.txt' into table emp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过insert命令将中间表的数据导入Hive与HBase关联的那张表中：insert into table hive_hbase_emp_table select * from emp;</p>
</li>
<li><p>查看Hive和HBase各自的表中是否已同步地插入了数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Hive</span></span><br><span class="line">select * from hive_hbase_emp_table;</span><br><span class="line"><span class="meta">#</span><span class="bash"> HBase</span></span><br><span class="line">scan 'hbase_emp_table'</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>案例二：在HBase中已经存储了某一张表hbase_emp_table，然后在Hive中创建一个外部表来关联HBase中的hbase_emp_table这张表，使之可以借助Hive来分析HBase这张表中的数据</p>
<ul>
<li><p>在Hive中创建外部表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTERNAL TABLE relevance_hbase_emp(</span><br><span class="line">empno int,</span><br><span class="line">ename string,</span><br><span class="line">job string,</span><br><span class="line">mgr int,</span><br><span class="line">hiredate string,</span><br><span class="line">sal double,</span><br><span class="line">comm double,</span><br><span class="line">deptno int)</span><br><span class="line">STORED BY 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span><br><span class="line">WITH SERDEPROPERTIES ("hbase.columns.mapping" = ":key,info:ename,info:job,info:mgr,info:hiredate,info:sal,info:comm,info:deptno")</span><br><span class="line">TBLPROPERTIES ("hbase.table.name" = "hbase_emp_table");</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看关联后Hive中外部表：select * from relevance_hbase_emp;</p>
</li>
<li><p>之后便可使用Hive进行一些数据分析</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="HBase优化"><a href="#HBase优化" class="headerlink" title="HBase优化"></a>HBase优化</h2><ul>
<li><p>高可用<br>在HBase中HMaster负责监控HRegionServer的生命周期，均衡RegionServer的负载，如果 HMaster挂掉了，那么整个HBase集群将陷入不健康的状态，并且此时的工作状态并不会维持太久。所以HBase支持对HMaster的高可用配置</p>
<ul>
<li><p>关闭启动的HBase集群：bin/stop-hbase.sh</p>
</li>
<li><p>在conf目录下创建backup-masters文件(文件名不得更改)：touch conf/backup-masters</p>
</li>
<li><p>在backup-masters中加入备用HMaster节点(当前HMaster配置是hadoop1,文件不得多出空格和换行)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop2</span><br><span class="line">hadoop3</span><br></pre></td></tr></table></figure>
</li>
<li><p>分发conf目录到其他hbase集群节点：xsync backup-masters</p>
</li>
<li><p>在hadoop1上启动HBase集群：bin/start-hbase.sh</p>
</li>
<li><p>打开页面查看：<a href="http://hadoop1:16010" target="_blank" rel="noopener">http://hadoop1:16010</a></p>
</li>
<li><p>使用jps查看hadoop1的HMaster进程，并使用kill -9 进程号杀死(杀两次,第二次杀失败,假活)</p>
</li>
<li><p>打开页面查看：<a href="http://hadoop2:16010" target="_blank" rel="noopener">http://hadoop2:16010</a>或<a href="http://hadoop3:16010" target="_blank" rel="noopener">http://hadoop3:16010</a></p>
</li>
</ul>
</li>
<li><p>预分区<br>每一个region维护着StartRow与EndRow，如果加入的数据符合某个Region维护的RowKey范围，则该数据交给这个Region维护。那么依照这个原则，我们可以将数据所要投放的分区提前大致规划好，以提高HBase性能</p>
<ul>
<li><p>手动设定预分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 具体分区信息可以在web页面的table中查看</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 四个键分五个区</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 逐个字符比较</span></span><br><span class="line">create 'staff1','info','partition1',SPLITS =&gt; ['1000','2000','3000','4000']</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成16禁止序列预分区(基本不用)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create 'staff2','info','partition2',&#123;NUMREGIONS =&gt; 15, SPLITALGO =&gt; 'HexStringSplit'&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照文件中设置的规则预分区<br>创建splits.txt文件内容如下：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aa</span><br><span class="line">bb</span><br><span class="line">dd</span><br><span class="line">cc</span><br></pre></td></tr></table></figure>

<p>  采用文件设置预分区形式</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 默认会对分区文件做排序,不然左开右闭会出问题</span></span><br><span class="line">create 'staff3','partition3',SPLITS_FILE =&gt; '/opt/module/data/hbase/splits.txt'</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用JavaAPI创建预分区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义算法，产生一系列hash散列值存储在二维数组中</span></span><br><span class="line"><span class="keyword">byte</span>[][] splitKeys = ...</span><br><span class="line"><span class="comment">// 还有四个参数的方法...</span></span><br><span class="line">admin.createTable(tableDescriptor,splitKeys);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>RowKey设计<br>一条数据的唯一标识就是RowKey，那么这条数据存储于哪个分区，取决于RowKey处于哪个一个预分区的区间内，设计RowKey的主要目的，就是让数据均匀的分布于所有的region中，在一定程度上防止数据倾斜。接下来我们就谈一谈RowKey常用的设计方案</p>
<ul>
<li>生成随机数、hash、散列值：比如SHA1</li>
<li>字符反转</li>
<li>字符串拼接</li>
<li>示例讲解<br>电信要求统计用户的时间段内的通话流水，根据什么分区，假如要分近300个区？<br>电话号码11位，为了将对应到300个分区，而且要求一个号码需要对应到一个分区。那么如果有些号码电话打的很多，那么一个分区可能还是有问题，所以根据号码和时间进行分区。如果分到1年，时间颗粒度太大；最好采用1月。<br>最终采用取余方式：hash(15988814888(电话号码) + 2020(年) + 07(月)) % 300——此处的’+’只做一个示意作用，具体需要实践和经验。<br>那么假如我需要获取15988814888用户在2020年6月份的通话流水，怎么根据startRowKey和endRowKey获取数据呢？<br>startRowKey(xxx为分区号,是根据公式计算得出的;最后是rowKey比较规则:有比没有大)：xxx_15988814888_2020_06<br>endRowKey(‘|’的ascii码很大,或者也可以为2020_03;这里不会出现第一位大于遮蔽第二位的问题)：xxx_15988814888_2020_06|</li>
</ul>
</li>
<li><p>内存优化<br>HBase操作过程中需要大量的内存开销，毕竟Table是可以缓存在内存中的，一般会分配整个可用内存的70%给HBase的Java堆。<strong>但是不建议分配非常大的堆内存</strong>，因为GC过程持续太久会导致RegionServer处于长期不可用状态，一般16~48G内存就可以了，如果因为框架占用内存过高导致系统内存不足，框架一样会被系统服务拖死</p>
</li>
<li><p>基础优化</p>
<ul>
<li><p>允许的HDFS的文件中追加内容(hdfs-site.xml、hbase-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">属性：dfs.support.append</span><br><span class="line">解释：开启HDFS追加同步，可以优秀地配合HBase的数据同步和持久化。默认值为true</span><br></pre></td></tr></table></figure>
</li>
<li><p>优化 DataNode 允许的最大文件打开数(hdfs-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">属性：dfs.datanode.max.transfer.threads</span><br><span class="line">解释：HBase一般都会同一时间操作大量的文件，根据集群的数量和规模以及数据动作，设置为4096或者更高。默认值：4096</span><br></pre></td></tr></table></figure>
</li>
<li><p>优化延迟高的数据操作的等待时间(hdfs-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">属性：dfs.image.transfer.timeout</span><br><span class="line">解释：如果对于某一次数据操作来讲，延迟非常高，socket需要等待更长的时间，建议把该值设置为更大的值(默认60000毫秒)，以确保socket不会被timeout掉</span><br></pre></td></tr></table></figure>
</li>
<li><p>优化数据的写入效率(mapred-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">属性：mapreduce.map.output.compress</span><br><span class="line">     mapreduce.map.output.compress.codec</span><br><span class="line">解释：开启这两个数据可以大大提高文件的写入效率，减少写入时间。第一个属性值修改为true，第二个属性值修改为：org.apache.hadoop.io.compress.GzipCodec或者其他压缩方式</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置RPC监听数量(hbase-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">属性：hbase.regionserver.handler.count</span><br><span class="line">解释：默认值为30，用于指定RPC监听的数量，可以根据客户端的请求数进行调整，读写请求较多时，增加此值</span><br></pre></td></tr></table></figure>
</li>
<li><p>优化HStore文件大小(hbase-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">属性：hbase.hregion.max.filesize</span><br><span class="line">解释：默认值10737418240(10GB)，如果需要运行HBase的MR任务，可以减小此值，因为一个 region对应一个map任务，如果单个region过大，会导致map任务执行时间过长。该值的意思就是，如果HFile的大小达到这个数值，则这个region会被切分为两个Hfile</span><br></pre></td></tr></table></figure>
</li>
<li><p>优化HBase客户端缓存(hbase-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">属性：hbase.client.write.buffer</span><br><span class="line">解释：用于指定Hbase客户端缓存，增大该值可以减少RPC调用次数，但是会消耗更多内存，反之则反之。一般我们需要设定一定的缓存大小，以达到减少RPC次数的目的</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定scan.next扫描HBase所获取的行数(hbase-site.xml)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">属性：hbase.client.scanner.caching</span><br><span class="line">解释：用于指定scan.next方法获取的默认行数，值越大，消耗内存越大</span><br></pre></td></tr></table></figure>
</li>
<li><p>flush、compact、split机制<br>当MemStore达到阈值，将Memstore中的数据Flush进Storefile；compact机制则是把flush出来的小文件合并成大的Storefile文件。split则是当Region达到阈值，会把过大的Region一分为二<br>涉及属性：hbase.hregion.memstore.flush.size = 134217728(即128M就是Memstore的默认阈值)<br>这个参数的作用是当单个HRegion内所有的Memstore大小总和超过指定值时，flush该HRegion的所有memstore。RegionServer的flush是通过将请求添加一个队列，模拟生产消费模型来异步处理的。那这里就有一个问题，当队列来不及消费，产生大量积压请求时，可能会导致内存陡增，最坏的情况是触发OOM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hbase.regionserver.global.memstore.upperLimit &#x3D; 0.4</span><br><span class="line">hbase.regionserver.global.memstore.lowerLimit &#x3D; 0.38</span><br></pre></td></tr></table></figure>

<p>当MemStore使用内存总量达到hbase.regionserver.global.memstore.upperLimit指定值时，将会有多个MemStores flush到文件中，MemStore flush顺序是按照大小降序执行的，直到刷新到MemStore使用内存略小于lowerLimit</p>
</li>
</ul>
</li>
</ul>

          
            <div class='article_footer'>
              
                
  
    
    



  

  
    
    



  

  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://sobxiong.github.io/2020/07/17/BigData/HBase/>https://sobxiong.github.io/2020/07/17/BigData/HBase/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


              
            </div>
          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-09-20T22:26:05+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2020年9月20日</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/BigData/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>BigData</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://sobxiong.github.io/2020/07/17/BigData/HBase/&title=HBase - SOBXiong的博客&summary=内容
HBase简介
HBase快速入门
HBase进阶
HBase-API
HBase优化
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://sobxiong.github.io/2020/07/17/BigData/HBase/&title=HBase - SOBXiong的博客&summary=内容
HBase简介
HBase快速入门
HBase进阶
HBase-API
HBase优化
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://sobxiong.github.io/2020/07/17/BigData/HBase/&title=HBase - SOBXiong的博客&summary=内容
HBase简介
HBase快速入门
HBase进阶
HBase-API
HBase优化
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2020/07/24/language/Scala/Scala/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>Scala</p>
                <p class='content'>内容
Scala概述
变量
运算符
程序流程控制
函数式编程基础
面向对象编程-基础
面向对象编程-中级



Scala概述
学习Scala的原因

Spark是新一代内存级大数据计算框架，是...</p>
              </a>
            
            
              <a class='next' href='/2020/07/06/BigData/Hive/'>
                <p class='title'>Hive<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>内容
Hive基本概念
Hive安装
Hive数据类型
DDL数据定义
DML数据操作
查询
例题实战(蚂蚁金服)
函数
压缩和存储
企业级调优
谷粒影音Hive实战
常见错误及解决方案



...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box reveal comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
          </div>
        </section>
      
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'HBase',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    



  <section class="widget toc-wrapper shadow desktop mobile" id="toc-div" >
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#内容"><span class="toc-text">内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase简介"><span class="toc-text">HBase简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase快速入门"><span class="toc-text">HBase快速入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase进阶"><span class="toc-text">HBase进阶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase-API"><span class="toc-text">HBase-API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase优化"><span class="toc-text">HBase优化</span></a></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="mailto:1942991710@qq.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/SOBXiong"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        <div class='copyright'>
        <p><a href="http://xiongjc.top" target="_blank" rel="noopener">Copyright © 2017-2020 SOBXiong</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>





  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '8px',
        duration: '800',
        interval: '100',
        scale: '1'
      });
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script defer src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>

  









  
    
<script src="https://cdn.jsdelivr.net/npm/valine@1.4/dist/Valine.min.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var meta = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick','mail','link'];
  var requiredFields = 'nick,mail'.split(',').filter(function(item){
    return REQUIRED_FIELDS.indexOf(item) > -1
  });
  var valine = new Valine();
  function emoji(path, idx, ext) {
      return path + "/" + path + "-" + idx + "." + ext;
  }
  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }
  valine.init({
    el: '#valine_container',
    meta: meta,
    
    appId: "dogUA2FSKGTo029M1SEwGROT-MdYXbMMI",
    appKey: "u0NdtQ8nvHoMdJPSYqm1LRxE",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'robohash',
    lang:'zh-cn',
    visitor: 'true',
    highlight: 'true',
    mathJax: 'false',
    enableQQ: 'true',
    requiredFields: requiredFields,
    emojiCDN: 'https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/emoji/valine/',
    emojiMaps: emojiMaps
  })
  </script>





  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>






<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".article-entry").find("img").not('.inline').not('a img').each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 标准 markdown 描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".article-entry").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  $(function () {
    pjax_fancybox();
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
